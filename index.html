<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ascent Protocol v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display.swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .stat-bar-bg { background-color: #374151; }
        .xp-bar { background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); transition: width 0.5s ease-in-out; }
        .int-bar { background: linear-gradient(90deg, #22d3ee 0%, #3b82f6 100%); transition: width 0.5s ease-in-out; }
        .str-bar { background: linear-gradient(90deg, #f87171 0%, #ef4444 100%); transition: width 0.5s ease-in-out; }
        .agi-bar { background: linear-gradient(90deg, #a3e635 0%, #4d7c0f 100%); transition: width 0.5s ease-in-out; }
        .cha-bar { background: linear-gradient(90deg, #facc15 0%, #f59e0b 100%); transition: width 0.5s ease-in-out; }
        .quest-card, .achievement-card { border: 1px solid #374151; transition: all 0.3s ease; }
        .quest-card:hover { border-color: #4f46e5; transform: translateY(-5px); }
        .deadline-warning { border-left: 4px solid #f59e0b; animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0%, 100% { border-left-color: #f59e0b; } 50% { border-left-color: #fef3c7; } }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        
        /* Skill Tree Styles */
        .skill-node { transition: all 0.2s ease; position: absolute; background-color: #1f2937; border: 2px solid #4b5563; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-align: center; flex-direction: column; cursor: pointer; padding: 2px; }
        .skill-node.locked { filter: grayscale(80%) brightness(0.7); cursor: not-allowed; }
        .skill-node.unlockable { border-color: #f59e0b; box-shadow: 0 0 12px rgba(245, 158, 11, 0.7); animation: pulse-yellow 2s infinite; }
        @keyframes pulse-yellow { 0%, 100% { box-shadow: 0 0 12px rgba(245, 158, 11, 0.7); } 50% { box-shadow: 0 0 20px rgba(252, 211, 77, 1); } }
        .skill-node.unlocked { border-color: #10b981; }
        .skill-node .skill-name { font-size: 9px; font-weight: bold; line-height: 1.1; }
        .skill-node .skill-icon { width: 20px; height: 20px; margin-bottom: 2px; }
        .skill-line { stroke: #4b5563; stroke-width: 2; }
        .skill-line.unlocked { stroke: #10b981; }
        
        .achievement-unlocked { background-color: #15803d; color: white; }
        #toast-notification { transition: transform 0.5s ease, opacity 0.5s ease; transform: translateY(100%); opacity: 0; z-index: 100; }
        #toast-notification.show { transform: translateY(0); opacity: 1; }
        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 p-4">
        <div class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-4">Welcome to The Ascent Protocol</h1>
            <p id="auth-status" class="text-gray-400 mb-8">Connecting to server...</p>
            <div id="auth-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-400 mx-auto"></div>
            <div id="auth-error-message" class="hidden"></div>
            <p id="user-id-display" class="mt-8 text-xs text-gray-500 break-all px-4"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-content" class="max-w-7xl mx-auto hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div class="text-center sm:text-left">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">The Ascent Protocol</h1>
                <p class="text-gray-400 mt-2">Your 90-Day Gamified Sprint to a Target Role</p>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 mt-4 sm:mt-0">
                <div id="skill-points-display" class="bg-gray-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg text-sm sm:text-base">Skill Points: 0</div>
                <button id="skill-tree-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base">Skill Tree</button>
                <button id="reset-progress-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base">Reset</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <!-- Player Stats -->
                <section id="player-stats" class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white">Character Sheet</h2>
                        <p id="player-level" class="text-indigo-400 font-semibold">Level 1 - Novice</p>
                    </div>
                    <div class="mb-6 mt-4">
                        <div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-300">XP</span><span id="xp-text" class="text-sm font-medium text-gray-400">0 / 1000</span></div>
                        <div class="w-full stat-bar-bg rounded-full h-4"><div id="xp-bar" class="xp-bar h-4 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-cyan-300">INT</span><span id="int-text" class="text-sm font-medium text-gray-400">0</span></div>
                            <div class="w-full stat-bar-bg rounded-full h-3"><div id="int-bar" class="int-bar h-3 rounded-full" style="width: 0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-red-400">STR</span><span id="str-text" class="text-sm font-medium text-gray-400">0</span></div>
                            <div class="w-full stat-bar-bg rounded-full h-3"><div id="str-bar" class="str-bar h-3 rounded-full" style="width: 0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-lime-400">AGI</span><span id="agi-text" class="text-sm font-medium text-gray-400">0</span></div>
                            <div class="w-full stat-bar-bg rounded-full h-3"><div id="agi-bar" class="agi-bar h-3 rounded-full" style="width: 0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1"><span class="font-bold text-yellow-400">CHA</span><span id="cha-text" class="text-sm font-medium text-gray-400">0</span></div>
                            <div class="w-full stat-bar-bg rounded-full h-3"><div id="cha-bar" class="cha-bar h-3 rounded-full" style="width: 0%"></div></div>
                        </div>
                    </div>
                </section>
                
                <section id="profile-analysis" class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white mb-4">AI-Powered Prep Tools</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Interview Story Generator ✨</h3>
                            <p class="text-sm text-gray-400 mb-3">Describe a project, and AI will help you draft a STAR method story for it.</p>
                            <textarea id="star-input" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg p-2 h-24" placeholder="e.g., Built the backend for an e-commerce site..."></textarea>
                            <button id="generate-star-btn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                                <span>Generate Story</span>
                            </button>
                            <textarea id="star-output" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2 mt-3 h-48" readonly placeholder="Your STAR story will appear here..."></textarea>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Profile Analysis</h3>
                            <canvas id="stats-chart"></canvas>
                        </div>
                    </div>
                </section>

                <section id="active-quests">
                    <h2 class="text-2xl font-bold text-white mb-4">Active & Completed Missions</h2>
                    <div id="active-quests-list" class="space-y-4"></div>
                </section>

                <section id="achievements">
                    <h2 class="text-2xl font-bold text-white mb-4">Achievements</h2>
                    <div id="achievements-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </section>
            </div>

            <aside class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-white mb-4">Mission Board</h2>
                <div id="mission-board-list" class="space-y-4 max-h-[1200px] overflow-y-auto pr-2"></div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <div id="proof-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md border border-gray-700"><div class="p-6">
            <h3 class="text-xl font-bold text-white mb-2" id="modal-title">Submit Proof</h3>
            <p class="text-gray-400 mb-4">Provide evidence of your work (e.g., GitHub link).</p>
            <form id="proof-form">
                <input type="hidden" id="modal-quest-id">
                <textarea id="modal-proof-text" rows="4" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg p-2" required></textarea>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 font-bold rounded-lg">Complete Mission</button>
                </div>
            </form>
        </div></div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700"><div class="p-6">
            <h3 class="text-xl font-bold text-white mb-2">AI Feedback ✨</h3>
            <div id="feedback-content" class="text-gray-300 mt-4 space-y-2"></div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="feedback-close-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Close</button>
            </div>
        </div></div>
    </div>

    <div id="skill-tree-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-gray-900 bg-opacity-90 rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] border border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white">Skill Constellation</h3>
                <button id="skill-tree-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="skill-tree-container" class="p-6 flex-grow overflow-auto">
                 <!-- Mobile view: vertical list -->
                <div id="skill-tree-mobile" class="md:hidden space-y-4"></div>
                <!-- Desktop view: radial layout -->
                <div id="skill-tree-desktop" class="hidden md:block relative w-full h-full">
                    <svg id="skill-lines-svg" class="absolute top-0 left-0 w-full h-full pointer-events-none"></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg">
        <p id="toast-text" class="font-semibold"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCswLXWdDMI50Q-6bj1Smi4KEiX_YIwff4",
          authDomain: "ascent-protocol-app.firebaseapp.com",
          projectId: "ascent-protocol-app",
          storageBucket: "ascent-protocol-app.firebasestorage.app",
          messagingSenderId: "276236549667",
          appId: "1:276236549667:web:b47a7ed18f449b24bfbb96",
          measurementId: "G-2WJQP6SZLY"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        let playerState = null;
        let unsubscribePlayerState = null; 
        let statsChart = null;

        let quests = {
            'dsa-easy': { name: "DSA: 5 Easy Problems", xp: 50, stats: { INT: 50 }, type: 'Weekly', skill: 'dsa-basics' },
            'dsa-medium': { name: "DSA: 3 Medium Problems", xp: 75, stats: { INT: 75 }, type: 'Weekly', skill: 'dsa-basics'},
            'dsa-contest': { name: "Weekly Contest", xp: 100, stats: { INT: 100 }, type: 'Weekly', skill: 'dsa-intermediate'},
            'project-setup': { name: "Project: Setup Repo", xp: 150, stats: { STR: 75, AGI: 75 }, type: 'Epic', skill: 'frontend-basics' },
            'resume-draft': { name: "Create Resume Draft", xp: 100, stats: { AGI: 100 }, type: 'Epic', skill: 'career-basics' },
            'backend-feature': { name: "Project: Backend Feature", xp: 500, stats: { STR: 500 }, type: 'Epic', skill: 'backend-api' },
            'resume-final': { name: "Finalize Resume", xp: 300, stats: { AGI: 300 }, type: 'Epic', skill: 'career-basics' },
            'github-readme': { name: "GitHub Profile README", xp: 200, stats: { AGI: 200 }, type: 'Epic', skill: 'personal-branding' },
            'project-deploy': { name: "Project: Deploy Live", xp: 1500, stats: { STR: 1500 }, type: 'Epic', skill: 'cloud-deploy' },
            'mock-interview': { name: "Mock Technical Interview", xp: 750, stats: { INT: 375, CHA: 375 }, type: 'Epic', skill: 'interview-prep' },
            'elevator-pitch': { name: "Practice Elevator Pitch", xp: 100, stats: { CHA: 100 }, type: 'Weekly', skill: 'comm-verbal' },
        };
        const levels = [
            { name: "Novice", xp_required: 0, skillPoints: 1 }, 
            { name: "Apprentice", xp_required: 1000, skillPoints: 1 },
            { name: "Adept", xp_required: 2500, skillPoints: 2 }, 
            { name: "Expert", xp_required: 5000, skillPoints: 2 },
            { name: "Master", xp_required: 8000, skillPoints: 3 }, 
            { name: "Grandmaster", xp_required: 12000, skillPoints: 3 },
        ];
        const achievements = {
            'dsa-initiate': { name: "DSA Initiate", description: "Complete 3 DSA missions.", xp: 100, trigger: (s) => s.completedQuests.filter(q => quests[q] && quests[q].skill.startsWith('dsa-')).length >= 2 },
            'profile-architect': { name: "Profile Architect", description: "Complete initial profile setup.", xp: 250, trigger: (s) => s.completedQuests.includes('resume-final') && s.completedQuests.includes('github-readme') },
            'project-live': { name: "Project Live!", description: "Deploy your first project.", xp: 2500, trigger: (s) => s.completedQuests.includes('project-deploy') },
        };
        
        const skillTreeData = {
            'core': { id: 'core', name: 'Core', icon: 'M13 10V3L4 14h7v7l9-11h-7z', dependencies: [], x: '50%', y: '50%' },
            // Hard Skills Branches
            'cs-fundamentals': { id: 'cs-fundamentals', name: 'CS Fundamentals', icon: 'M5 12h14M12 5l7 7-7 7', dependencies: ['core'], x: '50%', y: '30%' },
            'os': { id: 'os', name: 'OS', icon: 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z', dependencies: ['cs-fundamentals'], x: '40%', y: '20%' },
            'dbms': { id: 'dbms', name: 'DBMS', icon: 'M4 7v10m16-10v10M4 13h16m-7-9h2m-2 14h2', dependencies: ['cs-fundamentals'], x: '60%', y: '20%' },
            
            'dsa': { id: 'dsa', name: 'DSA', icon: 'M4 6h16M4 12h16M4 18h7', dependencies: ['core'], x: '25%', y: '50%' },
            'dsa-basics': { id: 'dsa-basics', name: 'DSA Basics', icon: 'M15 10l-5.5 5.5-3.5-3.5', dependencies: ['dsa'], x: '15%', y: '50%' },
            'dsa-intermediate': { id: 'dsa-intermediate', name: 'DSA Intermediate', icon: 'M17.657 18.657l-4.243-4.243m0 0l-4.243 4.243m4.243-4.243l4.243 4.243m-4.243-4.243l-4.243-4.243', dependencies: ['dsa-basics'], x: '5%', y: '50%' },
            
            'development': { id: 'development', name: 'Development', icon: 'M10 20l4-16m4 16l-4-16M4 9h16M4 15h16', dependencies: ['core'], x: '75%', y: '50%' },
            'frontend-basics': { id: 'frontend-basics', name: 'Frontend Basics', icon: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z', dependencies: ['development'], x: '85%', y: '40%' },
            'backend-api': { id: 'backend-api', name: 'Backend & APIs', icon: 'M5 12h14M12 5l7 7-7 7', dependencies: ['development'], x: '85%', y: '60%' },
            'fullstack-app': { id: 'fullstack-app', name: 'Full-Stack App', icon: 'M12 6V4m0 16v-2m0-10v2m0 6v2M6 12H4m16 0h-2m-10 0h2m6 0h2M9 15l-3 3m5-5l3 3m-5-5l-3-3m5 5l3-3', dependencies: ['frontend-basics', 'backend-api', 'dbms'], x: '95%', y: '50%' },
            'cloud-deploy': { id: 'cloud-deploy', name: 'Cloud & Deploy', icon: 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z', dependencies: ['fullstack-app'], x: '95%', y: '70%' },

            // Soft Skills Branches
            'communication': { id: 'communication', name: 'Communication', icon: 'M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z', dependencies: ['core'], x: '50%', y: '70%' },
            'comm-verbal': { id: 'comm-verbal', name: 'Verbal', icon: 'M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.148-6.348a1.76 1.76 0 011.15-2.176l5.416-1.49z', dependencies: ['communication'], x: '40%', y: '80%' },
            'comm-written': { id: 'comm-written', name: 'Written', icon: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z', dependencies: ['communication'], x: '60%', y: '80%' },

            'career-prep': { id: 'career-prep', name: 'Career Prep', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z', dependencies: ['core'], x: '25%', y: '80%' },
            'career-basics': { id: 'career-basics', name: 'Resume/LinkedIn', icon: 'M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V4a2 2 0 012-2h8a2 2 0 012 2v4z', dependencies: ['career-prep'], x: '15%', y: '90%' },
            'personal-branding': { id: 'personal-branding', name: 'Branding', icon: 'M13 10V3L4 14h7v7l9-11h-7z', dependencies: ['career-basics'], x: '25%', y: '95%' },
            'interview-prep': { id: 'interview-prep', name: 'Interview Prep', icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z', dependencies: ['career-basics', 'dsa-intermediate', 'comm-verbal'], x: '35%', y: '90%' },
        };

        const ui = {
            playerLevel: document.getElementById('player-level'), xpText: document.getElementById('xp-text'), xpBar: document.getElementById('xp-bar'),
            intText: document.getElementById('int-text'), intBar: document.getElementById('int-bar'), strText: document.getElementById('str-text'),
            strBar: document.getElementById('str-bar'), agiText: document.getElementById('agi-text'), agiBar: document.getElementById('agi-bar'),
            chaText: document.getElementById('cha-text'), chaBar: document.getElementById('cha-bar'), activeQuestsList: document.getElementById('active-quests-list'),
            missionBoardList: document.getElementById('mission-board-list'), proofModal: document.getElementById('proof-modal'), modalTitle: document.getElementById('modal-title'),
            modalQuestId: document.getElementById('modal-quest-id'), modalProofText: document.getElementById('modal-proof-text'), proofForm: document.getElementById('proof-form'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'), resetProgressBtn: document.getElementById('reset-progress-btn'),
            achievementsList: document.getElementById('achievements-list'), skillTreeBtn: document.getElementById('skill-tree-btn'),
            skillTreeModal: document.getElementById('skill-tree-modal'), skillTreeContainer: document.getElementById('skill-tree-container'),
            skillTreeDesktop: document.getElementById('skill-tree-desktop'), skillTreeMobile: document.getElementById('skill-tree-mobile'),
            skillTreeCloseBtn: document.getElementById('skill-tree-close-btn'), toast: document.getElementById('toast-notification'), toastText: document.getElementById('toast-text'),
            skillLinesSvg: document.getElementById('skill-lines-svg'), skillPointsDisplay: document.getElementById('skill-points-display'),
            generateStarBtn: document.getElementById('generate-star-btn'), starInput: document.getElementById('star-input'), starOutput: document.getElementById('star-output'),
            feedbackModal: document.getElementById('feedback-modal'), feedbackContent: document.getElementById('feedback-content'), feedbackCloseBtn: document.getElementById('feedback-close-btn'),
            authStatus: document.getElementById('auth-status'), authSpinner: document.getElementById('auth-spinner'), authErrorMessage: document.getElementById('auth-error-message'),
            userIdDisplay: document.getElementById('user-id-display'),
        };

        // --- Gemini API Call Helper ---
        async function callGeminiAPI(prompt) {
            const apiKey = ""; // Leave empty, handled by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from API");
                }
            } catch (error) {
                console.error("Gemini API call error:", error);
                return "Error: Could not get a response from the AI.";
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                ui.authStatus.textContent = "Loading your profile...";
                ui.userIdDisplay.textContent = `User ID: ${userId}`;
                initializePlayerData(userId);
                requestNotificationPermission();
                setInterval(checkDeadlinesAndNotify, 60 * 1000); // Check every minute
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    ui.authStatus.classList.add('hidden');
                    ui.authSpinner.classList.add('hidden');
                    ui.authErrorMessage.classList.remove('hidden');
                    ui.authErrorMessage.innerHTML = `
                        <div class="text-center p-6 bg-gray-800 rounded-lg shadow-xl border border-red-500">
                            <h1 class="text-3xl font-bold text-red-500 mb-4">Action Required: Enable Anonymous Sign-in</h1>
                            <p class="text-gray-300 mb-4">The app cannot connect because Anonymous Sign-in is disabled in your Firebase project. Please follow the steps below.</p>
                            <div class="text-left bg-gray-900 p-4 rounded-lg text-sm text-gray-300">
                                <p class="font-bold text-yellow-400 mb-2">How to Fix:</p>
                                <ol class="list-decimal list-inside space-y-2">
                                    <li>Go to your <strong class="text-white">Firebase Console</strong>.</li>
                                    <li>Navigate to <strong>Build > Authentication</strong>.</li>
                                    <li>Click the <strong>Sign-in method</strong> tab.</li>
                                    <li>Find <strong>Anonymous</strong> in the list, click it, and enable the toggle switch.</li>
                                    <li><strong>Refresh this page</strong> after saving the setting.</li>
                                </ol>
                            </div>
                        </div>
                    `;
                });
            }
        });

        async function initializePlayerData(uid) {
            const playerDocRef = doc(db, "artifacts", appId, "users", uid, "profile", "data");
            if (unsubscribePlayerState) unsubscribePlayerState();

            unsubscribePlayerState = onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    playerState = docSnap.data();
                    if (playerState.quests) {
                        quests = {...quests, ...playerState.quests};
                    }
                } else {
                    const newPlayerState = {
                        xp: 0, level: 1, stats: { INT: 0, STR: 0, AGI: 0, CHA: 0 }, activeQuests: {},
                        completedQuests: [], unlockedAchievements: [], unlockedSkills: ['core'],
                        skillPoints: 1, proofs: {}, quests: {}
                    };
                    setDoc(playerDocRef, newPlayerState).then(() => { playerState = newPlayerState; });
                }
                if (playerState) {
                    updateUI();
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                }
            }, (error) => { console.error("Firestore snapshot error:", error); });
        }

        async function savePlayerStateToDb() {
            if (!userId || !playerState) return;
            const playerDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            try { await setDoc(playerDocRef, playerState); } 
            catch (error) { console.error("Error saving player state:", error); }
        }

        function updateUI() {
            if (!playerState) return;
            const levelInfo = levels[playerState.level - 1] || levels[levels.length - 1];
            const nextLevelXP = levelInfo.xp_required;
            ui.playerLevel.textContent = `Level ${playerState.level} - ${levelInfo.name}`;
            ui.xpText.textContent = `${playerState.xp} / ${nextLevelXP}`;
            const xpPercentage = (playerState.xp / nextLevelXP) * 100;
            ui.xpBar.style.width = `${Math.min(100, xpPercentage)}%`;
            ui.skillPointsDisplay.textContent = `Skill Points: ${playerState.skillPoints}`;

            const maxStatPoints = 5000;
            Object.keys(playerState.stats).forEach(stat => {
                const statValue = playerState.stats[stat];
                const percentage = (statValue / maxStatPoints) * 100;
                ui[`${stat.toLowerCase()}Text`].textContent = statValue;
                ui[`${stat.toLowerCase()}Bar`].style.width = `${Math.min(100, percentage)}%`;
            });

            renderMissionBoard();
            renderActiveQuests();
            renderAchievements();
            updateStatsChart();
        }

        function levelUpCheck() {
            if (!playerState || playerState.level >= levels.length) return;
            const currentLevelInfo = levels[playerState.level - 1];
            if (playerState.xp >= currentLevelInfo.xp_required) {
                playerState.level++;
                const newLevelInfo = levels[playerState.level - 1];
                playerState.skillPoints += newLevelInfo.skillPoints;
                showToast(`Level Up! You are now Level ${playerState.level}. You gained ${newLevelInfo.skillPoints} Skill Point(s)!`);
            }
        }
        
        function completeQuest(questId, proof) {
            const quest = quests[questId];
            if (!quest || !playerState.activeQuests[questId]) return;
            playerState.xp += quest.xp;
            Object.entries(quest.stats).forEach(([stat, value]) => { playerState.stats[stat] += value; });
            delete playerState.activeQuests[questId];
            playerState.completedQuests.push(questId);
            playerState.proofs[questId] = proof;
            hideProofModal();
            levelUpCheck();
            checkAchievements();
        }
        
        function resetProgress() {
            if (confirm('Are you sure you want to reset all your progress? This cannot be undone.')) {
                playerState = {
                    xp: 0, level: 1, stats: { INT: 0, STR: 0, AGI: 0, CHA: 0 }, activeQuests: {},
                    completedQuests: [], unlockedAchievements: [], unlockedSkills: ['core'],
                    skillPoints: 1, proofs: {}, quests: {}
                };
                savePlayerStateToDb();
            }
        }

        function renderSkillTree() {
            const desktopContainer = ui.skillTreeDesktop;
            const mobileContainer = ui.skillTreeMobile;
            desktopContainer.innerHTML = '';
            mobileContainer.innerHTML = '';

            // Desktop Radial Layout
            Object.values(skillTreeData).forEach(skill => {
                const isUnlocked = playerState.unlockedSkills.includes(skill.id);
                const dependenciesMet = skill.dependencies.every(dep => playerState.unlockedSkills.includes(dep));
                const isUnlockable = !isUnlocked && dependenciesMet && playerState.skillPoints > 0;

                const node = document.createElement('div');
                node.id = `skill-${skill.id}`;
                node.className = 'skill-node';
                if (isUnlocked) node.classList.add('unlocked');
                else if (isUnlockable) node.classList.add('unlockable');
                else node.classList.add('locked');
                
                node.style.left = `calc(${skill.x} - 32px)`;
                node.style.top = `calc(${skill.y} - 32px)`;
                node.dataset.skillId = skill.id;

                node.innerHTML = `
                    <svg class="skill-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${skill.icon}"></path></svg>
                    <span class="skill-name">${skill.name}</span>
                `;
                if (isUnlockable) {
                    node.title = `Click to unlock for 1 Skill Point`;
                } else if (!isUnlocked && !dependenciesMet) {
                    node.title = `Requires: ${skill.dependencies.map(d => skillTreeData[d].name).join(', ')}`;
                }
                desktopContainer.appendChild(node);
            });

            // Mobile Vertical List Layout
            Object.values(skillTreeData).forEach(skill => {
                 if (skill.id === 'core') return; // Don't show core in list
                 const isUnlocked = playerState.unlockedSkills.includes(skill.id);
                 const dependenciesMet = skill.dependencies.every(dep => playerState.unlockedSkills.includes(dep));
                 const isUnlockable = !isUnlocked && dependenciesMet && playerState.skillPoints > 0;

                 const node = document.createElement('div');
                 node.className = `p-3 rounded-lg flex items-center justify-between border-2 ${isUnlocked ? 'unlocked' : 'border-gray-600'} ${!isUnlocked ? 'locked' : ''}`;
                 
                 node.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 ${isUnlocked ? 'text-green-400' : 'text-gray-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${skill.icon}"></path></svg>
                        <div>
                            <p class="font-bold text-sm">${skill.name}</p>
                            <p class="text-xs text-gray-400">Requires: ${skill.dependencies.map(d => skillTreeData[d].name).join(', ')}</p>
                        </div>
                    </div>
                 `;

                 if (isUnlockable) {
                     const unlockBtn = document.createElement('button');
                     unlockBtn.className = 'bg-yellow-500 text-black font-bold py-1 px-3 rounded-md text-sm';
                     unlockBtn.textContent = 'Unlock';
                     unlockBtn.dataset.skillId = skill.id;
                     node.appendChild(unlockBtn);
                 }
                 mobileContainer.appendChild(node);
            });

            setTimeout(() => {
                const svg = ui.skillLinesSvg;
                svg.innerHTML = ''; // Clear lines
                const containerRect = desktopContainer.getBoundingClientRect();
                Object.values(skillTreeData).forEach(skill => {
                    skill.dependencies.forEach(depId => {
                        const parentNode = document.getElementById(`skill-${depId}`);
                        const childNode = document.getElementById(`skill-${skill.id}`);
                        if (parentNode && childNode) {
                            const parentRect = parentNode.getBoundingClientRect();
                            const childRect = childNode.getBoundingClientRect();
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', parentRect.left - containerRect.left + parentRect.width / 2);
                            line.setAttribute('y1', parentRect.top - containerRect.top + parentRect.height / 2);
                            line.setAttribute('x2', childRect.left - containerRect.left + childRect.width / 2);
                            line.setAttribute('y2', childRect.top - containerRect.top + childRect.height / 2);
                            line.setAttribute('class', 'skill-line');
                            if (playerState.unlockedSkills.includes(skill.id)) {
                                line.classList.add('unlocked');
                            }
                            svg.appendChild(line);
                        }
                    });
                });
            }, 0);
        }

        async function automaticallyGenerateMissions(skillId, skillName) {
            const prompt = `Generate two simple, actionable 'Weekly' quests for a student learning about "${skillName}". For each quest, provide a 'name' (max 5 words), 'xp' (between 50-200), and which stat it improves ('INT', 'STR', 'AGI', or 'CHA'). Format the response as a JSON array of objects, like this: [{"name": "...", "xp": 100, "stat": "INT"}, ...].`;
            
            const response = await callGeminiAPI(prompt);
            try {
                const cleanedResponse = response.replace(/```json\n|```/g, '').trim();
                const newQuests = JSON.parse(cleanedResponse);
                newQuests.forEach(q => {
                    const newQuestId = `ai-${skillId}-${Date.now()}-${Math.random()}`;
                    quests[newQuestId] = {
                        name: `✨ ${q.name}`,
                        xp: q.xp,
                        stats: { [q.stat]: q.xp },
                        type: 'Weekly',
                        skill: skillId
                    };
                    playerState.quests[newQuestId] = quests[newQuestId];
                });
                savePlayerStateToDb();
                showToast(`Added ${newQuests.length} new AI missions for ${skillName}!`);
            } catch (err) {
                console.error("Failed to parse AI response for mission generation:", err, "Original response:", response);
                showToast("AI failed to generate valid missions.");
            }
        }

        function unlockSkill(skillId) {
            const skill = skillTreeData[skillId];
            if (!skill || playerState.unlockedSkills.includes(skillId) || playerState.skillPoints <= 0) return;
            const dependenciesMet = skill.dependencies.every(dep => playerState.unlockedSkills.includes(dep));
            if (dependenciesMet) {
                playerState.skillPoints--;
                playerState.unlockedSkills.push(skillId);
                showToast(`Unlocked: ${skill.name}!`);
                
                automaticallyGenerateMissions(skillId, skill.name);
                
                savePlayerStateToDb();
                renderSkillTree();
            }
        }
        
        function renderActiveQuests() {
            ui.activeQuestsList.innerHTML = '';
            const allQuestIds = [...Object.keys(playerState.activeQuests), ...playerState.completedQuests];
            const sortedQuestIds = allQuestIds.sort((a, b) => {
                const aIsActive = playerState.activeQuests[a];
                const bIsActive = playerState.activeQuests[b];
                if (aIsActive && !bIsActive) return -1;
                if (!aIsActive && bIsActive) return 1;
                return 0;
            });

            if (sortedQuestIds.length === 0) {
                ui.activeQuestsList.innerHTML = '<p class="text-gray-400">No active or completed missions.</p>';
                return;
            }

            sortedQuestIds.forEach(id => {
                const quest = quests[id];
                if(!quest) return;
                const isCompleted = playerState.completedQuests.includes(id);
                let content = '';

                if (isCompleted) {
                    content = `
                        <div class="quest-card bg-gray-900 p-4 rounded-lg opacity-60">
                            <h4 class="font-bold text-white line-through">${quest.name}</h4>
                            <p class="text-sm text-gray-400">Completed</p>
                            <button data-quest-id="${id}" class="feedback-quest-btn mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                                <span>Get AI Feedback ✨</span>
                            </button>
                        </div>`;
                } else {
                    const deadline = new Date(playerState.activeQuests[id].deadline);
                    const timeLeft = deadline.getTime() - new Date().getTime();
                    const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    let deadlineText = `Deadline: ${deadline.toLocaleDateString()}`, deadlineClass = '';
                    if (timeLeft > 0 && daysLeft <= 2) {
                        deadlineText += ` (${daysLeft} day${daysLeft > 1 ? 's' : ''} left)`;
                        deadlineClass = 'deadline-warning';
                    } else if (timeLeft <= 0) {
                        deadlineText = 'Deadline Passed!';
                        deadlineClass = 'border-l-4 border-red-500';
                    }
                    content = `
                        <div class="quest-card bg-gray-900 p-4 rounded-lg ${deadlineClass}">
                            <h4 class="font-bold text-white">${quest.name}</h4>
                            <p class="text-sm text-gray-400">${deadlineText}</p>
                            <button data-quest-id="${id}" class="complete-quest-btn mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Complete</button>
                        </div>`;
                }
                ui.activeQuestsList.innerHTML += content;
            });
        }
        
        function acceptQuest(questId) {
            const quest = quests[questId];
            if (!quest || playerState.activeQuests[questId]) return;
            let deadline = new Date();
            if (quest.type === 'Weekly') deadline.setDate(deadline.getDate() + 7);
            else if (quest.type === 'Epic') deadline.setDate(deadline.getDate() + 30);
            playerState.activeQuests[questId] = { deadline: deadline.toISOString(), alarmSent: false };
            savePlayerStateToDb();
        }

        function checkAchievements() {
            Object.entries(achievements).forEach(([id, achievement]) => {
                if (!playerState.unlockedAchievements.includes(id) && achievement.trigger(playerState)) {
                    playerState.unlockedAchievements.push(id);
                    playerState.xp += achievement.xp;
                    showToast(`Achievement Unlocked: ${achievement.name}! (+${achievement.xp} XP)`);
                }
            });
            savePlayerStateToDb();
        }

        function renderMissionBoard() {
            ui.missionBoardList.innerHTML = '';
            const availableQuests = Object.entries(quests).filter(([id, quest]) => 
                !playerState.completedQuests.includes(id) && 
                !playerState.activeQuests[id] &&
                playerState.unlockedSkills.includes(quest.skill)
            );

            if (availableQuests.length === 0) {
                ui.missionBoardList.innerHTML = '<p class="text-gray-400">No new missions available. Unlock more skills!</p>';
                return;
            }

            availableQuests.forEach(([id, quest]) => {
                const questCard = `
                    <div class="quest-card bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-bold text-white">${quest.name}</h4>
                        <p class="text-sm text-gray-400">Type: ${quest.type}</p>
                        <div class="text-sm mt-2">
                            <span class="font-semibold text-yellow-400">+${quest.xp} XP</span>
                            ${Object.entries(quest.stats).map(([stat, val]) => ` | <span class="font-semibold text-cyan-400">+${val} ${stat}</span>`).join('')}
                        </div>
                        <button data-quest-id="${id}" class="accept-quest-btn mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Accept Mission</button>
                    </div>
                `;
                ui.missionBoardList.innerHTML += questCard;
            });
        }

        function renderAchievements() {
            ui.achievementsList.innerHTML = '';
            Object.entries(achievements).forEach(([id, ach]) => {
                const isUnlocked = playerState.unlockedAchievements.includes(id);
                const card = `
                    <div class="achievement-card text-center p-3 rounded-lg ${isUnlocked ? 'achievement-unlocked' : 'bg-gray-700'}" title="${ach.description}\n+${ach.xp} XP">
                        <div class="text-2xl mb-1">${isUnlocked ? '🏆' : '❓'}</div>
                        <p class="text-xs font-semibold">${ach.name}</p>
                    </div>
                `;
                ui.achievementsList.innerHTML += card;
            });
        }

        function updateStatsChart() {
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const data = {
                labels: ['INT', 'STR', 'AGI', 'CHA'],
                datasets: [{
                    label: 'Current Stats',
                    data: Object.values(playerState.stats),
                    fill: true,
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: 'rgb(99, 102, 241)',
                    pointBackgroundColor: 'rgb(99, 102, 241)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(99, 102, 241)'
                }]
            };
            if (statsChart) {
                statsChart.data = data;
                statsChart.update();
            } else {
                statsChart = new Chart(ctx, {
                    type: 'radar', data: data,
                    options: {
                        scales: { r: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, angleLines: { color: 'rgba(255, 255, 255, 0.1)' }, pointLabels: { color: '#fff', font: { size: 14 } } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        
        function showToast(message) {
            ui.toastText.textContent = message;
            ui.toast.classList.add('show');
            setTimeout(() => { ui.toast.classList.remove('show'); }, 3000);
        }

        function showProofModal(questId) {
            ui.modalTitle.textContent = `Submit Proof for: ${quests[questId].name}`;
            ui.modalQuestId.value = questId;
            ui.modalProofText.value = '';
            ui.proofModal.classList.remove('hidden');
        }
        function hideProofModal() { ui.proofModal.classList.add('hidden'); }
        
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Notification permission granted.");
                    }
                });
            }
        }

        function checkDeadlinesAndNotify() {
            if (!playerState || Notification.permission !== "granted") return;
            
            let stateChanged = false;
            const now = new Date().getTime();
            const oneDay = 24 * 60 * 60 * 1000;

            Object.entries(playerState.activeQuests).forEach(([id, questData]) => {
                const deadline = new Date(questData.deadline).getTime();
                if (!questData.alarmSent && (deadline - now < oneDay)) {
                    const questName = quests[id].name;
                    new Notification("Ascent Protocol Deadline!", {
                        body: `Your mission "${questName}" is due in less than 24 hours!`,
                    });
                    playerState.activeQuests[id].alarmSent = true;
                    stateChanged = true;
                }
            });

            if (stateChanged) {
                savePlayerStateToDb();
            }
        }

        // Event Listeners
        ui.missionBoardList.addEventListener('click', (e) => { if (e.target.classList.contains('accept-quest-btn')) acceptQuest(e.target.dataset.questId); });
        ui.activeQuestsList.addEventListener('click', (e) => { 
            if (e.target.classList.contains('complete-quest-btn')) showProofModal(e.target.dataset.questId); 
            if (e.target.closest('.feedback-quest-btn')) {
                const btn = e.target.closest('.feedback-quest-btn');
                const questId = btn.dataset.questId;
                const proof = playerState.proofs[questId];
                if (proof) {
                    btn.innerHTML = '<div class="spinner"></div>';
                    const prompt = `You are a senior software engineer reviewing a junior developer's work. The developer submitted the following as proof of completing a task: "${proof}". Provide 2-3 bullet points of constructive feedback. Focus on potential improvements, best practices, or things they did well. Keep the tone encouraging. Format the output as simple HTML bullet points (e.g., <ul><li>...</li></ul>).`;
                    callGeminiAPI(prompt).then(feedback => {
                        ui.feedbackContent.innerHTML = feedback;
                        ui.feedbackModal.classList.remove('hidden');
                        btn.innerHTML = 'Get AI Feedback ✨';
                    });
                } else {
                    showToast("No proof was submitted for this mission.");
                }
            }
        });
        ui.proofForm.addEventListener('submit', (e) => { e.preventDefault(); completeQuest(ui.modalQuestId.value, ui.modalProofText.value); });
        ui.modalCancelBtn.addEventListener('click', hideProofModal);
        ui.resetProgressBtn.addEventListener('click', resetProgress);
        ui.skillTreeBtn.addEventListener('click', () => { ui.skillTreeModal.classList.remove('hidden'); renderSkillTree(); });
        ui.skillTreeCloseBtn.addEventListener('click', () => ui.skillTreeModal.classList.add('hidden'));
        ui.skillTreeContainer.addEventListener('click', (e) => {
            const node = e.target.closest('.skill-node, .bg-yellow-500');
            if (node) {
                const skillId = node.dataset.skillId;
                if (skillId && (node.classList.contains('unlockable') || node.tagName === 'BUTTON')) {
                     unlockSkill(skillId);
                }
            }
        });
        ui.generateStarBtn.addEventListener('click', async () => {
            const input = ui.starInput.value;
            if (!input.trim()) {
                showToast("Please describe your project first.");
                return;
            }
            const btn = ui.generateStarBtn;
            btn.innerHTML = '<div class="spinner"></div>';
            const prompt = `Based on the experience "${input}", generate a concise story using the STAR method for a behavioral interview question like 'Tell me about a challenging project.'. Format it clearly with "Situation:", "Task:", "Action:", and "Result:" headings.`;
            const story = await callGeminiAPI(prompt);
            ui.starOutput.value = story;
            btn.innerHTML = '<span>Generate Story</span>';
        });
        ui.feedbackCloseBtn.addEventListener('click', () => ui.feedbackModal.classList.add('hidden'));

    </script>
</body>
</html>
